<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Log Requests in Go" /><meta property="og:locale" content="en" /><meta name="description" content="Log requests in Golang using an HTTP middleware with tracing support." /><meta property="og:description" content="Log requests in Golang using an HTTP middleware with tracing support." /><link rel="canonical" href="https://mzampetakis.com/posts/Log-Requests-in-Go/" /><meta property="og:url" content="https://mzampetakis.com/posts/Log-Requests-in-Go/" /><meta property="og:site_name" content="Michalis Zampetakis" /><meta property="og:image" content="https://mzampetakis.com/assets/posts/Log-Requests-in-Go/railway.jpg" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-08-18T04:40:00+08:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://mzampetakis.com/assets/posts/Log-Requests-in-Go/railway.jpg" /><meta property="twitter:title" content="Log Requests in Go" /><meta name="twitter:site" content="@mzampetakis" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-03-20T02:50:32+08:00","datePublished":"2020-08-18T04:40:00+08:00","description":"Log requests in Golang using an HTTP middleware with tracing support.","headline":"Log Requests in Go","image":{"show_in_post":false,"url":"https://mzampetakis.com/assets/posts/Log-Requests-in-Go/railway.jpg","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://mzampetakis.com/posts/Log-Requests-in-Go/"},"url":"https://mzampetakis.com/posts/Log-Requests-in-Go/"}</script><title>Log Requests in Go | Michalis Zampetakis</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Michalis Zampetakis"><meta name="application-name" content="Michalis Zampetakis"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/img/sample/me.jpg " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Michalis Zampetakis</a></div><div class="site-subtitle font-italic">Curiosity Driven</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/now/" class="nav-link"> <i class="fa-fw fas fa-clock ml-xl-3 mr-xl-3 unloaded"></i> <span>NOW</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/mzampetakis" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/mzampetakis" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['mzampetakis','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="" aria-label="linkedin" > <i class="fab fa-linkedin"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Log Requests in Go</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Log Requests in Go</h1><div class="post-meta text-muted"><div></div><div class="d-flex"><div> <span> Posted <em class="timeago" inalid-data-ts="1597696800" > Aug 18, 2020 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1042 words"> <em>5 min</em> read</span></div></div></div><div class="post-content"><p>Itâ€™s a common sense that logging your HTTP request in your application is essential. The reasons for doing so are numerous. Error reporting, tracing, monitoring, performance tuning and so on.</p><p>One of the easiest way to do this in Go is by using an HTTP middleware. Bellow we will show a simple but elegant way of doing it!</p><h2 id="what-is-a-middleware"><span class="mr-2">What is a middleware</span><a href="#what-is-a-middleware" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>When we build a web server it is common to use some logic among multiple endpoints to perform some tasks. Some of these tasks might be to authenticate the user, to add some headers in the response or just log something!</p><blockquote><p>An HTTP middleware in Go allows to abstract and share functionality among multiple requests.</p></blockquote><p>So, an HTTP middleware allows us to organize this functionality in a higher level. More specifically, between the router and the handlers.</p><h2 id="a-simple-middleware"><span class="mr-2">A Simple middleware</span><a href="#a-simple-middleware" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>A minimum middleware set up in Go requires setting up the handler and a handle function with the desired middleware.</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
	<span class="s">"log"</span>
	<span class="s">"net/http"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">myMiddleware</span><span class="p">(</span><span class="n">next</span> <span class="n">http</span><span class="o">.</span><span class="n">Handler</span><span class="p">)</span> <span class="n">http</span><span class="o">.</span><span class="n">Handler</span> <span class="p">{</span>
	<span class="k">return</span> <span class="n">http</span><span class="o">.</span><span class="n">HandlerFunc</span><span class="p">(</span><span class="k">func</span><span class="p">(</span><span class="n">w</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">log</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Entering middleware"</span><span class="p">)</span>
		<span class="n">next</span><span class="o">.</span><span class="n">ServeHTTP</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
		<span class="n">log</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Leaving middlewareOne"</span><span class="p">)</span>
	<span class="p">})</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">handleFunc</span><span class="p">(</span><span class="n">w</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">log</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Executing handleFunc"</span><span class="p">)</span>
	<span class="n">w</span><span class="o">.</span><span class="n">Write</span><span class="p">([]</span><span class="kt">byte</span><span class="p">(</span><span class="s">"OK"</span><span class="p">))</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">mux</span> <span class="o">:=</span> <span class="n">http</span><span class="o">.</span><span class="n">NewServeMux</span><span class="p">()</span>
	<span class="n">handler</span> <span class="o">:=</span> <span class="n">http</span><span class="o">.</span><span class="n">HandlerFunc</span><span class="p">(</span><span class="n">handleFunc</span><span class="p">)</span>
	<span class="n">mux</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="s">"/"</span><span class="p">,</span> <span class="n">myMiddleware</span><span class="p">(</span><span class="n">handler</span><span class="p">))</span>
	<span class="n">log</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Listening on :8000..."</span><span class="p">)</span>
	<span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">ListenAndServe</span><span class="p">(</span><span class="s">":8000"</span><span class="p">,</span> <span class="n">mux</span><span class="p">))</span>
<span class="p">}</span>
</pre></table></code></div></div><p>The magic happens in line <code class="language-plaintext highlighter-rouge">24</code> where we enforce the <code class="language-plaintext highlighter-rouge">myMiddleware</code> to be used by our handler for our <code class="language-plaintext highlighter-rouge">handler</code>. Running the above will give us the following result:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="go">2020/08/12 20:08:35 Listening on 8000...
2020/08/12 20:08:40 Entering middleware
2020/08/12 20:08:40 Executing handleFunc
2020/08/12 20:08:40 Leaving middleware
</span></pre></table></code></div></div><p>This makes sense how can we exploit middlewares to achieve the desired result every single time. Middlewares can be cascaded but this requires to take extra care for the order that will be used.</p><h3 id="log-requests"><span class="mr-2">Log Requests</span><a href="#log-requests" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>Back to the request logging we require some request details to be logged in our application. Thankfully all this information is within <code class="language-plaintext highlighter-rouge">*http.Request</code>. So for our example we could log the request using this middleware:</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="k">func</span> <span class="n">myMiddleware</span><span class="p">(</span><span class="n">next</span> <span class="n">http</span><span class="o">.</span><span class="n">Handler</span><span class="p">)</span> <span class="n">http</span><span class="o">.</span><span class="n">Handler</span> <span class="p">{</span>
	<span class="k">return</span> <span class="n">http</span><span class="o">.</span><span class="n">HandlerFunc</span><span class="p">(</span><span class="k">func</span><span class="p">(</span><span class="n">w</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">log</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Entering middleware"</span><span class="p">)</span>
		<span class="n">log</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"%s : Method: %s | URL: %s%s | Proto: %s"</span><span class="p">,</span>
			<span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">RFC3339</span><span class="p">),</span> <span class="n">r</span><span class="o">.</span><span class="n">Method</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">Host</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">URL</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">Proto</span><span class="p">)</span>
		<span class="n">next</span><span class="o">.</span><span class="n">ServeHTTP</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
		<span class="n">log</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Leaving middleware"</span><span class="p">)</span>
	<span class="p">})</span>
<span class="p">}</span>
</pre></table></code></div></div><p>At line <code class="language-plaintext highlighter-rouge">4</code> the middleware logs a Datetime alongside some basic information of the request. The output we get is as follows:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="go">2020/08/12 20:44:15 Listening on 8000...
2020/08/12 20:44:20 Entering middleware
2020/08/12 20:44:20 2020-08-17T22:14:40+03:00 : Method: GET | URL: localhost:8000/ | Proto: HTTP/1.1
2020/08/12 20:44:20 Executing handleFunc
2020/08/12 20:44:20 Leaving middleware
</span></pre></table></code></div></div><blockquote><p>There is no need to log explicitly date and time as <code class="language-plaintext highlighter-rouge">log</code> already prefixes our logging string.</p></blockquote><h3 id="tracing-support"><span class="mr-2">Tracing support</span><a href="#tracing-support" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>Moving a step forward for our request logger we would like to add some tracing information for each request. Apart from creating and logging a unique request id we should also save this generated uuid within each request. There is no better place to save this other that the HTTP context.</p><blockquote><p>Context package makes it easy to pass request-scoped values, cancelation signals, and deadlines across API boundaries to all the goroutines involved in handling a request.</p></blockquote><p>More about the Goâ€™s context package can be found <a href="https://golang.org/pkg/context/">here</a>.</p><p>The following middleware generates a uuid, logs at the request logging and passes it inside the requestâ€™s context.</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="k">func</span> <span class="n">myMiddleware</span><span class="p">(</span><span class="n">next</span> <span class="n">http</span><span class="o">.</span><span class="n">Handler</span><span class="p">)</span> <span class="n">http</span><span class="o">.</span><span class="n">Handler</span> <span class="p">{</span>
	<span class="k">return</span> <span class="n">http</span><span class="o">.</span><span class="n">HandlerFunc</span><span class="p">(</span><span class="k">func</span><span class="p">(</span><span class="n">w</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">log</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Entering myMiddleware"</span><span class="p">)</span>
		<span class="n">requestID</span> <span class="o">:=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">New</span><span class="p">()</span>
		<span class="n">log</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"%s : %s: Method: %s | URL: %s%s | Proto: %s"</span><span class="p">,</span>
			<span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">RFC3339</span><span class="p">),</span> <span class="n">requestID</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">Method</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">Host</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">URL</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">Proto</span><span class="p">)</span>
		<span class="n">ctx</span> <span class="o">:=</span> <span class="n">context</span><span class="o">.</span><span class="n">WithValue</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">Context</span><span class="p">(),</span> <span class="s">"request-id"</span><span class="p">,</span> <span class="n">requestID</span><span class="p">)</span>
		<span class="n">next</span><span class="o">.</span><span class="n">ServeHTTP</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">WithContext</span><span class="p">(</span><span class="n">ctx</span><span class="p">))</span>
		<span class="n">log</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Leaving myMiddleware"</span><span class="p">)</span>
	<span class="p">})</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Now, the request log prints the generated request uuid and has the following format:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="go">2020/08/12 22:17:36 Listening on 8000...
2020/08/12 22:17:39 Entering middleware
2020/08/12 22:17:39 2020-08-17T22:17:39+03:00 : a81ea2c1-55c3-4a31-b331-b5acf2cfac6d: Method: GET | URL: localhost:8000/ | Proto: HTTP/1.1
2020/08/12 22:17:39 Executing handleFunc
2020/08/12 22:17:39 Leaving middleware
</span></pre></table></code></div></div><p>From this point we have access to this request-id within our handler function allowing us to log with this unique id.</p><blockquote><p>Keep in mind that now our middleware has a double role. The first is to log each request and the second on is to populate the context with a <code class="language-plaintext highlighter-rouge">request-id</code>. This might not be a preferred solution, however, it was easier to demonstrate it here like this.</p></blockquote><p>At this point all seem good. Thatâ€™s not completely correct. As seen <a href="https://go-review.googlesource.com/c/go/+/30084">heat this issue</a>:</p><blockquote><p>Using a context.Context Value key of type string is a terrible idea and walks into the minefield of a global namespace. We shouldâ€™ve outlawed it from day 1. All context value keys should be made from user-defined types.</p></blockquote><p>Which means we have to use an alternative/custom type for our <code class="language-plaintext highlighter-rouge">request-id</code> context key.</p><p>The following could solve the issue we just describef by introducing the <code class="language-plaintext highlighter-rouge">RequestIDKey</code> type and use it when setting the value into context.</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="c">// RequestIDKey type is the type used as key to store request-id into context</span>
<span class="k">type</span> <span class="n">RequestIDKey</span> <span class="kt">string</span>

<span class="k">func</span> <span class="n">myMiddleware</span><span class="p">(</span><span class="n">next</span> <span class="n">http</span><span class="o">.</span><span class="n">Handler</span><span class="p">)</span> <span class="n">http</span><span class="o">.</span><span class="n">Handler</span> <span class="p">{</span>
	<span class="k">return</span> <span class="n">http</span><span class="o">.</span><span class="n">HandlerFunc</span><span class="p">(</span><span class="k">func</span><span class="p">(</span><span class="n">w</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">log</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Entering myMiddleware"</span><span class="p">)</span>
		<span class="n">requestID</span> <span class="o">:=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">New</span><span class="p">()</span>
		<span class="n">log</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"%s : %s: Method: %s | URL: %s%s | Proto: %s"</span><span class="p">,</span>
			<span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">RFC3339</span><span class="p">),</span> <span class="n">requestID</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">Method</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">Host</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">URL</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">Proto</span><span class="p">)</span>
		<span class="n">requestIDKey</span> <span class="o">:=</span> <span class="n">RequestIDKey</span><span class="p">(</span><span class="s">"request-id"</span><span class="p">)</span>
		<span class="n">ctx</span> <span class="o">:=</span> <span class="n">context</span><span class="o">.</span><span class="n">WithValue</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">Context</span><span class="p">(),</span> <span class="n">requestIDKey</span><span class="p">,</span> <span class="n">requestID</span><span class="p">)</span>
		<span class="n">next</span><span class="o">.</span><span class="n">ServeHTTP</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">WithContext</span><span class="p">(</span><span class="n">ctx</span><span class="p">))</span>
		<span class="n">log</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Leaving myMiddleware"</span><span class="p">)</span>
	<span class="p">})</span>
<span class="p">}</span>
</pre></table></code></div></div><p>From now on, the same type <code class="language-plaintext highlighter-rouge">RequestIDKey</code> should be used in order to retrieve the <code class="language-plaintext highlighter-rouge">request-id</code> whenever needed!</p><h2 id="log-response"><span class="mr-2">Log response</span><a href="#log-response" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>We can now easily log the response of each handler. Just by extending our middleware after the <code class="language-plaintext highlighter-rouge">log.Println("Leaving middleware")</code> line and using the <code class="language-plaintext highlighter-rouge">http.ResponseWriter</code> object. We could use the same middleware or another one depending on our case.</p><h2 id="conclusion"><span class="mr-2">Conclusion</span><a href="#conclusion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>As mentioned earlier, middlewares have many use cases. Logging is just one of them. Middlwares are used in most API services in Go for authentication and authorization, for compression, for recovery for setting content type and many more cases.</p><p>Extra caution should be taken when using multiple middlewares as well as when group of routes are used!</p></div><div class="post-tail-wrapper text-muted"><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/golang/" class="post-tag no-text-decoration" >golang</a> <a href="/tags/coding/" class="post-tag no-text-decoration" >coding</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Log+Requests+in+Go+-+Michalis+Zampetakis&url=https%3A%2F%2Fmzampetakis.com%2Fposts%2FLog-Requests-in-Go%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Log+Requests+in+Go+-+Michalis+Zampetakis&u=https%3A%2F%2Fmzampetakis.com%2Fposts%2FLog-Requests-in-Go%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fmzampetakis.com%2Fposts%2FLog-Requests-in-Go%2F&text=Log+Requests+in+Go+-+Michalis+Zampetakis" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/golang/">golang</a> <a class="post-tag" href="/tags/coding/">coding</a> <a class="post-tag" href="/tags/testing/">testing</a> <a class="post-tag" href="/tags/blogging/">blogging</a> <a class="post-tag" href="/tags/image-processing/">image-processing</a> <a class="post-tag" href="/tags/lego/">LEGO</a> <a class="post-tag" href="/tags/oauth/">oAuth</a> <a class="post-tag" href="/tags/shell/">shell</a> <a class="post-tag" href="/tags/time/">time</a> <a class="post-tag" href="/tags/toy-project/">toy-project</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/AquaGo-A-Toy-Project/"><div class="card-body"> <em class="timeago small" inalid-data-ts="1598902800" > Sep 1, 2020 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>AquaGo - A Toy Project</h3><div class="text-muted small"><p> Just imagine if you could have on your livingâ€™s room TV an aquarium! Wouldnâ€™t that be nice, especially during the hot period of summertime? What about if you could add digital fishes and decorative...</p></div></div></a></div><div class="card"> <a href="/posts/Deep-Dive-in-Go-Channels/"><div class="card-body"> <em class="timeago small" inalid-data-ts="1604123700" > Oct 31, 2020 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Deep Dive in Go Channels</h3><div class="text-muted small"><p> One of the biggest advantages of Go is undoubtedly itâ€™s concurrency management. Goroutines are the main feature that Go uses to achieve this. Goroutines wouldnâ€™t be so easy if there wasnâ€™t for chan...</p></div></div></a></div><div class="card"> <a href="/posts/Exec-Command/"><div class="card-body"> <em class="timeago small" inalid-data-ts="1620319200" > May 7, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Exec.Command</h3><div class="text-muted small"><p> One of the key features of Go is the considerably rich standard library. Goâ€™s os package offers a wide range of methods and functions to allow programmers to exploit the hostâ€™s OS capabilities. U...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Hello-Blog/" class="btn btn-outline-primary" prompt="Older"><p>Hello Blog</p></a> <a href="/posts/AquaGo-A-Toy-Project/" class="btn btn-outline-primary" prompt="Newer"><p>AquaGo - A Toy Project</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> Â© 2023 <a href="https://mzampetakis.com">Michalis Zampetakis</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme. Images from <a href="https://unsplash.com/" target="_blank" rel="noopener">Unsplash</a></p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/golang/">golang</a> <a class="post-tag" href="/tags/coding/">coding</a> <a class="post-tag" href="/tags/testing/">testing</a> <a class="post-tag" href="/tags/blogging/">blogging</a> <a class="post-tag" href="/tags/image-processing/">image-processing</a> <a class="post-tag" href="/tags/lego/">LEGO</a> <a class="post-tag" href="/tags/oauth/">oAuth</a> <a class="post-tag" href="/tags/shell/">shell</a> <a class="post-tag" href="/tags/time/">time</a> <a class="post-tag" href="/tags/toy-project/">toy-project</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-172730569-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-172730569-1'); }); </script>
